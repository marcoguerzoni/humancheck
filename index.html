<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Human Check</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=IBM+Plex+Sans:wght@300;400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #F7F5F0;
    --card: #FFFFFF;
    --ink: #1A1A1A;
    --ink2: #555;
    --accent: #2D5A27;
    --accent-light: #E8F0E7;
    --accent-hover: #3D7A35;
    --border: #DDD8D0;
    --red: #B83A3A;
    --radius: 10px;
    --shadow: 0 2px 12px rgba(0,0,0,.06);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'IBM Plex Sans', sans-serif;
    background: var(--bg);
    color: var(--ink);
    min-height: 100vh;
    line-height: 1.6;
  }
  header {
    text-align: center;
    padding: 48px 24px 36px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, #fff 0%, var(--bg) 100%);
  }
  header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2.6rem;
    letter-spacing: -0.02em;
    color: var(--accent);
    margin-bottom: 10px;
  }
  header p {
    max-width: 540px;
    margin: 0 auto;
    font-size: 1.02rem;
    color: var(--ink2);
    font-weight: 300;
  }
  header p strong { font-weight: 600; color: var(--ink); }
  .screen { display: none; }
  .screen.active { display: block; }
  #email-screen {
    max-width: 480px;
    margin: 60px auto;
    padding: 0 24px;
    text-align: center;
  }
  #email-screen label {
    font-size: 1.1rem;
    font-weight: 500;
    display: block;
    margin-bottom: 8px;
  }
  #email-screen .privacy-note {
    font-size: 0.85rem;
    color: var(--ink2);
    margin-bottom: 20px;
    font-style: italic;
    line-height: 1.5;
  }
  #email-input {
    width: 100%;
    padding: 14px 18px;
    font-size: 1rem;
    font-family: 'IBM Plex Mono', monospace;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    outline: none;
    transition: border-color .2s;
  }
  #email-input:focus { border-color: var(--accent); }
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 13px 32px;
    font-size: 1rem;
    font-weight: 600;
    font-family: 'IBM Plex Sans', sans-serif;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all .2s;
  }
  .btn-primary {
    background: var(--accent);
    color: #fff;
    margin-top: 20px;
  }
  .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(45,90,39,.25); }
  .btn-primary:disabled { opacity: .45; cursor: not-allowed; transform: none; box-shadow: none; }
  .btn-stop {
    background: transparent;
    color: var(--red);
    border: 2px solid var(--red);
  }
  .btn-stop:hover { background: #FDF0F0; }
  #survey-screen {
    max-width: 1280px;
    margin: 0 auto;
    padding: 32px 24px 80px;
  }
  .paper-counter {
    text-align: center;
    font-size: 0.85rem;
    color: var(--ink2);
    margin-bottom: 12px;
    font-family: 'IBM Plex Mono', monospace;
  }
  .instruction-box {
    max-width: 800px;
    margin: 0 auto 24px;
    padding: 16px 24px;
    background: var(--accent-light);
    border-left: 4px solid var(--accent);
    border-radius: 0 var(--radius) var(--radius) 0;
    font-size: 0.95rem;
    color: var(--ink);
    line-height: 1.6;
  }
  .instruction-box strong { color: var(--accent); }
  .survey-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 28px;
    align-items: start;
  }
  .paper-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 32px;
    max-height: 78vh;
    display: flex;
    flex-direction: column;
  }
  .paper-panel h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 1.45rem;
    line-height: 1.35;
    margin-bottom: 20px;
    color: var(--ink);
  }
  .abstract-scroll {
    flex: 1;
    overflow-y: auto;
    font-size: 0.95rem;
    color: var(--ink2);
    line-height: 1.75;
    padding-right: 12px;
  }
  .abstract-scroll::-webkit-scrollbar { width: 5px; }
  .abstract-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .rating-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .jel-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 20px 24px;
    transition: border-color .2s;
  }
  .jel-card:hover { border-color: var(--accent); }
  .jel-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }
  .jel-badge {
    font-family: 'IBM Plex Mono', monospace;
    font-weight: 600;
    font-size: 0.92rem;
    background: var(--accent-light);
    color: var(--accent);
    padding: 4px 10px;
    border-radius: 6px;
    white-space: nowrap;
  }
  .jel-name {
    font-size: 0.9rem;
    color: var(--ink2);
    font-weight: 400;
  }
  .rating-row {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .rating-label {
    font-size: 0.78rem;
    color: var(--ink2);
    width: 90px;
    text-align: right;
    flex-shrink: 0;
  }
  .rating-label.right-label {
    text-align: left;
    width: auto;
  }
  .rating-btns { display: flex; gap: 4px; }
  .rate-btn {
    padding: 8px 20px;
    height: 36px;
    border: 2px solid var(--border);
    border-radius: 6px;
    background: #fff;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    color: var(--ink2);
    transition: all .15s;
  }
  .rate-btn:hover { border-color: var(--accent); color: var(--accent); }
  .rate-btn.selected-yes {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  .rate-btn.selected-no {
    background: var(--red);
    border-color: var(--red);
    color: #fff;
  }
  .actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 28px;
  }
  .validation-msg {
    text-align: center;
    color: var(--red);
    font-size: 0.88rem;
    margin-top: 10px;
    min-height: 22px;
  }
  .error-box {
    max-width: 700px;
    margin: 30px auto;
    padding: 20px 24px;
    background: #FFF5F5;
    border: 1px solid var(--red);
    border-radius: var(--radius);
    color: var(--red);
    font-size: 0.9rem;
    font-family: 'IBM Plex Mono', monospace;
    white-space: pre-wrap;
    word-break: break-all;
    display: none;
  }
  #thanks-screen {
    max-width: 500px;
    margin: 80px auto;
    text-align: center;
    padding: 0 24px;
  }
  #thanks-screen h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem;
    color: var(--accent);
    margin-bottom: 12px;
  }
  #thanks-screen p { color: var(--ink2); font-size: 1.05rem; margin-bottom: 24px; }
  .download-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--accent);
    border: 2px solid var(--accent);
    border-radius: var(--radius);
    text-decoration: none;
    cursor: pointer;
    transition: all .2s;
  }
  .download-link:hover { background: var(--accent-light); }
  .stats-bar {
    margin-top: 16px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.85rem;
    color: var(--ink2);
  }
  @media (max-width: 860px) {
    .survey-grid { grid-template-columns: 1fr; }
    .paper-panel { max-height: 40vh; }
    header h1 { font-size: 2rem; }
  }
</style>
</head>
<body>

<header>
  <h1>Human Check</h1>
  <p>You are helping <strong>Marco</strong> and <strong>Diletta</strong> evaluate their classification algorithm.
  You will not be paid, but you will earn our never-ending gratitude.</p>
</header>

<div class="error-box" id="error-box"></div>

<!-- EMAIL SCREEN -->
<div id="email-screen" class="screen active">
  <label for="email-input">Your email address</label>
  <p class="privacy-note">We collect your email only to identify your work position.<br>It will not be used for any other purpose.</p>
  <input type="email" id="email-input" placeholder="you@university.edu" autocomplete="email">
  <br>
  <button class="btn btn-primary" id="btn-next" disabled>Next →</button>
</div>

<!-- SURVEY SCREEN -->
<div id="survey-screen" class="screen">
  <div class="paper-counter" id="paper-counter"></div>
  <div class="instruction-box">
    You will be shown the title and abstract of a paper, along with five JEL classification codes. For each code, please click <strong>Yes</strong> if you can find <em>any trace</em> of the concept described by that JEL code in the paper — otherwise click <strong>No</strong>.
  </div>
  <div class="survey-grid">
    <div class="paper-panel">
      <h2 id="paper-title"></h2>
      <div class="abstract-scroll" id="paper-abstract"></div>
    </div>
    <div class="rating-panel" id="rating-panel"></div>
  </div>
  <div class="validation-msg" id="validation-msg"></div>
  <div class="actions">
    <button class="btn btn-primary" id="btn-another">✓ Save &amp; Next</button>
    <button class="btn btn-stop" id="btn-stop">■ Save &amp; Stop</button>
  </div>
</div>

<!-- THANK YOU SCREEN -->
<div id="thanks-screen" class="screen">
  <h2>Thank you!</h2>
  <p>Your evaluations have been saved. We truly appreciate your help.</p>
  <div class="stats-bar" id="stats-bar"></div>
  <br>
  <a class="download-link" id="download-btn">⬇ Download your responses (CSV)</a>
</div>

<script>
// ── CONFIG ──
const DATASET_URL = 'datasetAlexCausal_sample.csv';
const JELCODE_URL = 'jelcode.json';
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwipkQof5DFC20FBDfg7O4byslZ-8l_CMSxVnwN9FbKWyd4m0RpHrWHlKxRg-xUVx23/exec';

// ── STATE ──
let dataset = [];
let jelLookup = {};
let allJelCodes = [];
let userEmail = '';
let responses = [];
let papersRated = 0;
let usedIndices = new Set();

// ── ERROR DISPLAY ──
function showError(msg) {
  const box = document.getElementById('error-box');
  box.style.display = 'block';
  box.textContent += msg + '\n\n';
  console.error('[HumanCheck]', msg);
}

// ── CSV PARSER using PapaParse-style logic ──
function parseCSV(text) {
  // Remove BOM
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  text = text.trim();
  if (!text) return { headers: [], rows: [] };

  // Detect separator from first line
  const firstLine = text.split(/\r?\n/)[0];
  const commas = (firstLine.match(/,/g) || []).length;
  const semis = (firstLine.match(/;/g) || []).length;
  const tabs = (firstLine.match(/\t/g) || []).length;
  let sep = ',';
  if (semis > commas && semis > tabs) sep = ';';
  else if (tabs > commas && tabs > semis) sep = '\t';

  // Split into lines respecting quoted fields — keep quote chars in output
  const lines = [];
  let cur = '';
  let inQ = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') {
      cur += ch;  // KEEP the quote character
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if ((ch === '\n' || ch === '\r') && !inQ) {
      if (cur.trim()) lines.push(cur);
      cur = '';
      if (ch === '\r' && text[i+1] === '\n') i++;
    } else {
      cur += ch;
    }
  }
  if (cur.trim()) lines.push(cur);

  function splitRow(row) {
    const fields = [];
    let f = '', q = false;
    for (let i = 0; i < row.length; i++) {
      const c = row[i];
      if (c === '"') {
        if (q && row[i+1] === '"') { f += '"'; i++; } // escaped quote
        else { q = !q; } // toggle — don't add quote to field value
      }
      else if (c === sep && !q) { fields.push(f); f = ''; }
      else { f += c; }
    }
    fields.push(f);
    return fields.map(x => x.trim());
  }

  const headers = splitRow(lines[0]);
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = splitRow(lines[i]);
    const obj = {};
    headers.forEach((h, j) => { obj[h] = vals[j] || ''; });
    rows.push(obj);
  }
  return { headers, rows, sep };
}

function parseJelList(val) {
  if (!val || val === '[]' || val.toLowerCase() === 'nan') return [];
  try {
    const parsed = JSON.parse(val.replace(/'/g, '"'));
    if (Array.isArray(parsed)) return parsed.map(x => String(x).trim().toUpperCase()).filter(Boolean);
  } catch(e) {}
  return val.replace(/[\[\]'"]/g, '').split(',').map(x => x.trim().toUpperCase()).filter(Boolean);
}

// Case-insensitive column finder
function findCol(headers, candidates) {
  const lowerHeaders = headers.map(h => h.toLowerCase().trim());
  for (const c of candidates) {
    const idx = lowerHeaders.indexOf(c.toLowerCase());
    if (idx !== -1) return headers[idx];
  }
  // partial match
  for (const c of candidates) {
    const idx = lowerHeaders.findIndex(h => h.includes(c.toLowerCase()));
    if (idx !== -1) return headers[idx];
  }
  return null;
}

// ── LOAD DATA ──
async function loadData() {
  try {
    // ── Fetch dataset ──
    console.log('[HumanCheck] Fetching:', DATASET_URL);
    const dsResp = await fetch(DATASET_URL);
    if (!dsResp.ok) throw new Error(`Cannot fetch ${DATASET_URL} — HTTP ${dsResp.status}. Is the file in the same folder as index.html?`);
    const dsText = await dsResp.text();
    console.log('[HumanCheck] Dataset: ' + dsText.length + ' chars, first 200: ' + dsText.substring(0, 200));

    // ── Fetch JEL codes (JSON) ──
    console.log('[HumanCheck] Fetching:', JELCODE_URL);
    const jelResp = await fetch(JELCODE_URL);
    if (!jelResp.ok) throw new Error('Cannot fetch ' + JELCODE_URL + ' — HTTP ' + jelResp.status);
    var rawLookup = await jelResp.json();
    Object.keys(rawLookup).forEach(function(k) {
      var upper = k.toUpperCase();
      jelLookup[upper] = rawLookup[k];
      allJelCodes.push(upper);
    });
    console.log('[HumanCheck] Loaded ' + allJelCodes.length + ' JEL codes');
    console.log('[HumanCheck] Lookup test C13:', jelLookup['C13']);
    console.log('[HumanCheck] Lookup test J22:', jelLookup['J22']);

    // ── Parse dataset ──
    const ds = parseCSV(dsText);
    console.log('[HumanCheck] Dataset headers:', ds.headers, '| rows:', ds.rows.length, '| sep:', JSON.stringify(ds.sep));

    if (ds.rows.length === 0) {
      showError('Dataset parsed to 0 rows.\nHeaders found: ' + ds.headers.join(', '));
      return;
    }

    const colTitle = findCol(ds.headers, ['title', 'Title']);
    const colAbstract = findCol(ds.headers, ['abstract', 'Abstract']);
    const colTheo = findCol(ds.headers, ['theoretical', 'Theoretical']);
    const colMeth = findCol(ds.headers, ['methodological', 'Methodological']);
    const colId = findCol(ds.headers, ['id', 'ID', 'paper_id', 'doi']);

    console.log('[HumanCheck] Mapped columns → title: "' + colTitle + '", abstract: "' + colAbstract + '", theoretical: "' + colTheo + '", methodological: "' + colMeth + '", id: "' + colId + '"');

    const missing = [];
    if (!colTitle) missing.push('title');
    if (!colAbstract) missing.push('abstract');
    if (!colTheo) missing.push('theoretical');
    if (!colMeth) missing.push('methodological');
    if (missing.length > 0) {
      showError('Cannot find column(s): ' + missing.join(', ') + '\n\nHeaders in CSV: ' + ds.headers.join(', ') + '\n\nFirst data row:\n' + JSON.stringify(ds.rows[0]).substring(0, 500));
      return;
    }

    // Show a sample row for debugging
    console.log('[HumanCheck] Sample row[0] theoretical raw:', ds.rows[0][colTheo]);
    console.log('[HumanCheck] Sample row[0] methodological raw:', ds.rows[0][colMeth]);
    console.log('[HumanCheck] Sample row[0] title:', ds.rows[0][colTitle]?.substring(0, 80));

    // ── Filter eligible papers ──
    let totalRows = ds.rows.length;
    ds.rows.forEach((row, idx) => {
      const th = parseJelList(row[colTheo]);
      const me = parseJelList(row[colMeth]);
      if (th.length >= 2 && me.length >= 2) {
        dataset.push({
          index: idx,
          id: colId ? (row[colId] || String(idx)) : String(idx),
          title: row[colTitle] || '(no title)',
          abstract: row[colAbstract] || '(no abstract)',
          theoretical: th,
          methodological: me
        });
      }
    });

    console.log('[HumanCheck] Total rows: ' + totalRows + ', eligible (≥2 theo + ≥2 meth): ' + dataset.length);
    if (dataset.length > 0) {
      console.log('[HumanCheck] First eligible:', dataset[0].title.substring(0, 80), '| theo:', dataset[0].theoretical, '| meth:', dataset[0].methodological);
    } else {
      // Extra debug: show why nothing qualified
      let sample = ds.rows.slice(0, 3).map((r, i) => {
        return 'Row ' + i + ': theo="' + r[colTheo] + '" → parsed=' + JSON.stringify(parseJelList(r[colTheo])) +
               ', meth="' + r[colMeth] + '" → parsed=' + JSON.stringify(parseJelList(r[colMeth]));
      }).join('\n');
      showError('0 eligible papers after filtering (need ≥2 theoretical + ≥2 methodological).\n\nSample rows:\n' + sample);
    }

  } catch (err) {
    showError('Error loading data:\n' + err.message +
      '\n\n─── If testing locally ───\nYou MUST use a local web server. Open a terminal in the folder containing index.html and run:\n\n  python3 -m http.server 8000\n\nThen open http://localhost:8000');
    console.error(err);
  }
}

// ── PICK RANDOM PAPER ──
function pickPaper() {
  if (usedIndices.size >= dataset.length) usedIndices.clear();
  let idx;
  do { idx = Math.floor(Math.random() * dataset.length); }
  while (usedIndices.has(idx) && usedIndices.size < dataset.length);
  usedIndices.add(idx);
  return dataset[idx];
}

function pickRandomJel(exclude) {
  const excSet = new Set(exclude.map(c => c.toUpperCase()));
  const candidates = allJelCodes.filter(c => !excSet.has(c));
  if (candidates.length === 0) return allJelCodes[Math.floor(Math.random() * allJelCodes.length)];
  return candidates[Math.floor(Math.random() * candidates.length)];
}

// ── RENDER SURVEY ──
let currentPaper = null;
let currentJelItems = [];

function renderSurvey() {
  const paper = pickPaper();
  currentPaper = paper;
  papersRated++;

  document.getElementById('paper-counter').textContent = 'Paper #' + papersRated;
  document.getElementById('paper-title').textContent = paper.title;
  document.getElementById('paper-abstract').textContent = paper.abstract;

  const th1 = paper.theoretical[0], th2 = paper.theoretical[1];
  const me1 = paper.methodological[0], me2 = paper.methodological[1];
  const fourCodes = [th1, th2, me1, me2];
  const randCode = pickRandomJel(fourCodes);

  currentJelItems = [
    { code: th1, isRandom: false },
    { code: th2, isRandom: false },
    { code: me1, isRandom: false },
    { code: me2, isRandom: false },
    { code: randCode, isRandom: true }
  ];

  // Shuffle
  for (let i = currentJelItems.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [currentJelItems[i], currentJelItems[j]] = [currentJelItems[j], currentJelItems[i]];
  }

  const panel = document.getElementById('rating-panel');
  panel.innerHTML = '';
  currentJelItems.forEach((item, i) => {
    const name = jelLookup[item.code] || 'Unknown code';
    if (name === 'Unknown code') {
      console.log('[HumanCheck] UNKNOWN code: "' + item.code + '" charCodes:', Array.from(item.code).map(function(c){return c.charCodeAt(0);}));
    }
    const card = document.createElement('div');
    card.className = 'jel-card';
    card.innerHTML =
      '<div class="jel-header">' +
        '<span class="jel-badge">' + item.code + '</span>' +
        '<span class="jel-name">' + name + '</span>' +
      '</div>' +
      '<div class="rating-row">' +
        '<div class="rating-btns" data-idx="' + i + '">' +
          '<button class="rate-btn" data-val="1">Yes</button>' +
          '<button class="rate-btn" data-val="0">No</button>' +
        '</div>' +
      '</div>';
    panel.appendChild(card);
  });

  // Click handlers for rating buttons
  panel.querySelectorAll('.rating-btns').forEach(function(group) {
    group.querySelectorAll('.rate-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        group.querySelectorAll('.rate-btn').forEach(function(b) { b.classList.remove('selected-yes', 'selected-no'); });
        btn.classList.add(btn.dataset.val === '1' ? 'selected-yes' : 'selected-no');
        document.getElementById('validation-msg').textContent = '';
      });
    });
  });

  document.getElementById('paper-abstract').scrollTop = 0;
  document.getElementById('validation-msg').textContent = '';
}

function collectRatings() {
  var ratings = [];
  var allFilled = true;
  document.querySelectorAll('.rating-btns').forEach(function(group, i) {
    var sel = group.querySelector('.rate-btn.selected-yes, .rate-btn.selected-no');
    if (!sel) { allFilled = false; return; }
    ratings.push({
      paper_id: currentPaper.id,
      jel_code: currentJelItems[i].code,
      email: userEmail,
      rating: parseInt(sel.dataset.val),
      is_random: currentJelItems[i].isRandom ? 1 : 0
    });
  });
  return allFilled ? ratings : null;
}

function saveRatings(newRatings) {
  responses.push.apply(responses, newRatings);
  if (GOOGLE_SCRIPT_URL) {
    newRatings.forEach(function(r) {
      var params = '?paper_id=' + encodeURIComponent(r.paper_id) +
                   '&jel_code=' + encodeURIComponent(r.jel_code) +
                   '&email=' + encodeURIComponent(r.email) +
                   '&rating=' + encodeURIComponent(r.rating) +
                   '&is_random=' + encodeURIComponent(r.is_random);
      var iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.sandbox = 'allow-scripts allow-same-origin';
      iframe.src = GOOGLE_SCRIPT_URL + params;
      document.body.appendChild(iframe);
      // Clean up after 10 seconds
      setTimeout(function() { document.body.removeChild(iframe); }, 10000);
    });
    console.log('[HumanCheck] Sent ' + newRatings.length + ' ratings to Google Sheets');
  }
}

function generateCSV() {
  var header = 'paper_id,jel_code,email,rating,is_random';
  var rows = responses.map(function(r) {
    return '"' + r.paper_id + '","' + r.jel_code + '","' + r.email + '",' + r.rating + ',' + r.is_random;
  });
  return header + '\n' + rows.join('\n');
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
  document.getElementById(id).classList.add('active');
}

// ── INIT ──
document.addEventListener('DOMContentLoaded', function() {
  // Warn about file:// protocol
  if (window.location.protocol === 'file:') {
    showError('⚠ file:// protocol detected — browsers block CSV loading from file://.\n\nPlease use a local server instead:\n\n  cd ' + (window.location.pathname.replace(/\/[^/]*$/, '') || 'your-folder') + '\n  python3 -m http.server 8000\n\nThen open: http://localhost:8000');
  }

  var emailInput = document.getElementById('email-input');
  var btnNext = document.getElementById('btn-next');

  emailInput.addEventListener('input', function() {
    btnNext.disabled = !emailInput.value.includes('@');
  });

  btnNext.addEventListener('click', async function() {
    userEmail = emailInput.value.trim();
    showScreen('survey-screen');
    document.getElementById('paper-counter').textContent = 'Loading data…';
    document.getElementById('paper-title').textContent = '';
    document.getElementById('paper-abstract').textContent = '';
    document.getElementById('rating-panel').innerHTML = '';

    await loadData();

    if (dataset.length === 0) {
      document.getElementById('paper-counter').textContent = '❌ No eligible papers found — check the error box above and the browser console (F12).';
      return;
    }
    renderSurvey();
  });

  document.getElementById('btn-another').addEventListener('click', function() {
    var ratings = collectRatings();
    if (!ratings) {
      document.getElementById('validation-msg').textContent = 'Please rate all five JEL codes before proceeding.';
      return;
    }
    saveRatings(ratings);
    renderSurvey();
  });

  document.getElementById('btn-stop').addEventListener('click', function() {
    var ratings = collectRatings();
    if (!ratings) {
      document.getElementById('validation-msg').textContent = 'Please rate all five JEL codes before saving.';
      return;
    }
    saveRatings(ratings);
    document.getElementById('stats-bar').textContent =
      'You rated ' + papersRated + ' paper' + (papersRated > 1 ? 's' : '') + ' (' + responses.length + ' JEL evaluations total).';
    showScreen('thanks-screen');
  });

  document.getElementById('download-btn').addEventListener('click', function() {
    var csv = generateCSV();
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'output.csv';
    a.click();
    URL.revokeObjectURL(url);
  });
});
</script>
</body>
</html>